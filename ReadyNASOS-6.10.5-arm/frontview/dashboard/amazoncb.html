<!DOCTYPE html>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Amazon Drive Callback</title>    

    <!-- ExtJs -->
    <script type="text/javascript" src="./extjs/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="./extjs/ext-all.js"></script>

    <script type="text/javascript">
    
    function initialize()
    {
        if (Ext)
        {
            var param = location.search;
            param = param.substring(1);

            var code = Ext.urlDecode(param);

            var notAuth = '<?xml version="1.0" encoding="UTF-8"?>' +
                          '<xs:nml xmlns:xs="http://www.netgear.com/protocol/transaction/NMLSchema-0.9" xmlns="urn:netgear:nas:readynasd" src="browser" dst="nas">' +
                          '<xs:transaction id="">' +
                          '<xs:set id="opid" resource-id="AmazonDriveProvisioning" resource-type="AmazonDrive">' +
                          '<AmazonDriveProvisioning state="denied"/>' +
                          '</xs:set>' +
                          '</xs:transaction>' +
                          '</xs:nml>';

            var auth = '<?xml version="1.0" encoding="UTF-8"?>' +
                       '<xs:nml xmlns:xs="http://www.netgear.com/protocol/transaction/NMLSchema-0.9" xmlns="urn:netgear:nas:readynasd" src="browser" dst="nas">' +
                       '<xs:transaction id="">' +
                       '<xs:set id="opid" resource-id="AmazonDriveProvisioning" resource-type="AmazonDrive">' +
                       '<AmazonDriveProvisioning state="authorized" auth_code="' + code['code'] + '"/>' +
                       '</xs:set>' +
                       '</xs:transaction>' +
                       '</xs:nml>';


            if (param === 'not_approved=true')
            {
                Ext.Ajax.request({
                    url: '/dbbroker',
                    success: reqSuccess,
                    method: 'POST',
                    xmlData: notAuth
                });
            }
            else
            {
                Ext.Ajax.request({
                    url: '/dbbroker',
                    success: reqSuccess,
                    method: 'POST',
                    xmlData: auth
                });                
            }            
        }
    }

    function reqSuccess()
    {
        window.open('', '_self');
        window.close();
    }
    
    </script>
</head>
<body onload="initialize()">
    <div style="height: 40px; width: 200px; margin: 40px auto; font-size: 16px;">Redirecting. Please wait...</div>
</body>
</html>
