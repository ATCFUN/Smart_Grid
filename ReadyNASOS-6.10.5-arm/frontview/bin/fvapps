#!/bin/bash

# setup for apps. called by systemd::apache2.service, StartExecPre=/frontview/bin/fvapps

# check if READONLY mode
if ! >/apps/.tobedelete ; then
  # If read-only, then /apps/{AppName}/ is readonly and will fail to open log
  for f in $(find /etc/apache2/sites-enabled -type l); do
    conf=$(readlink $f)
    if [ ${conf#/apps/} != ${conf} ]; then
      rm $f
    fi
  done
  exit 0
fi
rm /apps/.tobedelete || true

### Fix apache config for sites-enabled
for p in /etc/apache2/sites-enabled/*; do
  [ ! -L $p ] && continue
  x=$(readlink $p)
  [ "${x:0:6}" == "/apps/" ] && rm $p
done
for p in /apps/*; do
  if [ ! -r $p/http.conf ]; then
    continue
  fi
  app=$(basename $p)
  ln -s $p/http.conf /etc/apache2/sites-enabled/090-$app.conf
  if ! apachectl -t >/dev/null 2>/dev/null; then
    echo "WARNING: Excluding bad http config for app '$app'"
    rnutil event_push shell readynasd "<xs:add-s resource-type=\"Log\" resource-id=\"Log\"><Log severity=\"notice\" message-tag=\"LOGMSG_APPLICATION_EXCLUDE_BAD_CONFIG\" category=\"system\"><args appname=\"$app\"/></Log></xs:add-s>" 0 0
    rm -f /etc/apache2/sites-enabled/090-$app.conf
  fi
done

### Fix apache config for <VirtualHost *:443>
CONF=/etc/frontview/apache/apps-https.conf
cat <<EOF >$CONF
# *** DO NOT EDIT. Automatically generated by /frontview/bin/fvapps. **
<Location /apps/logo>
	Options Indexes FollowSymLinks
	AllowOverride None
	Order allow,deny
	allow from all
	Include /etc/frontview/apache/Admin_Auth.conf
</Location>
EOF
chmod 775 /apps
for p in /apps/*; do
  if [ ! -r $p/config.xml -o ! -r $p/logo.png ]; then
    continue
  fi
  app=$(basename $p)
  if [ -d "/apps/$app/web" ]; then
    echo "Alias /apps/$app /apps/$app/web" >>$CONF
  fi
  if [ -r "/apps/$app/logo.png" ]; then
    echo "Alias /apps/logo/$app.png /apps/$app/logo.png" >>$CONF
  fi
  if [ -r $p/https.conf ]; then
    echo "Include $p/https.conf" >>$CONF
    if ! apachectl -t >/dev/null 2>/dev/null; then
      echo "WARNING: Excluding bad https config for app '$app'"
      rnutil event_push shell readynasd "<xs:add-s resource-type=\"Log\" resource-id=\"Log\"><Log severity=\"notice\" message-tag=\"LOGMSG_APPLICATION_EXCLUDE_BAD_CONFIG\" category=\"system\"><args appname=\"$app\"/></Log></xs:add-s>" 0 0
      sed -i '$ d' $CONF
    fi
  fi
done

# Logos for available local app (freeapp)
for p in /apps/.freeapps/*; do
  if [ ! -r $p/config.xml -o ! -r $p/logo.png ]; then
    continue
  fi
  app=$(basename $p)
  if [ -d "/apps/$app" ]; then
    continue
  fi
  echo "Alias /apps/logo/$app.png /apps/.freeapps/$app/logo.png" >>$CONF
done

### Install systemd unit definition
find /lib/systemd -name "fvapp-*.service" -a '!' -name "fvapp-*-installer.service" -exec rm {} \;
for p in /apps/*; do
  app=$(basename $p)
  if [ -r $p/fvapp-$app.service ]; then
    cp $p/fvapp-$app.service /lib/systemd/system/
    chmod a-x /lib/systemd/system/fvapp-$app.service
    RELOAD=1
  fi
done
[ -n "$RELOAD" ] && systemctl --system daemon-reload
exit 0
