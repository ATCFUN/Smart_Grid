Scada.VisGraphics={};var $VG=Scada.VisGraphics;$VG.iconGrid=new Ext.DataView({cls:"scada-icon-grid",store:Scada.Vis.iconStore,tpl:new Ext.XTemplate('<tpl for=".">','<div class="scada-icon-wrap scada-image-deletable">','<div class="scada-icon">','<div class="scada-icon-delete" data-id="{icon}" data-mode="icon"></div>','<img src="/scada/resources/icons/{icon}?{mtime}" title="{icon}">',"</div>",'<div class="scada-icon-title">{icon}</div>',"</div>","</tpl>",'<div class="x-clear"></div>')}),$VG.imgGrid=new Ext.DataView({cls:"scada-icon-grid",store:Scada.Vis.imgStore,tpl:new Ext.XTemplate('<tpl for=".">','<div class="scada-icon-wrap scada-image-deletable">','<div class="scada-icon">','<div class="scada-icon-delete" data-id="{image}" data-mode="image"></div>','<img src="/scada/resources/img/{image}?{mtime}" title="{image}">',"</div>",'<div class="scada-icon-title">{image}</div>',"</div>","</tpl>",'<div class="x-clear"></div>')}),$VG.fontStore=new Ext.data.JsonStore({fields:["id","name","type"],root:"fonts",url:Scada.reqUrl("vis","fonts"),sortInfo:{field:"name",direction:"ASC"}}),$VG.fontStoreReload=function(){$VG.fontStore.reload()},$VG.getFontName=function(e,e,t){var a=t.data;return a.name+" ("+a.type+")"},$VG.fontGrid=new Ext.grid.GridPanel($def.grid({id:"scada-font-grid",store:$VG.fontStore,border:!1,colModel:new Ext.grid.ColumnModel({defaults:{width:.1,sortable:!1,menuDisabled:!0},columns:[{header:$tr("visgraphics_font_name"),width:.95,renderer:$VG.getFontName},{header:$tr("delete"),width:.05,xtype:"boolclscolumn",falseCls:"scada-cell-delete",dataIndex:"delete"}]})})),$VG.deleteBtn={text:$tr("visgraphics_delete_selected"),iconCls:"icon-clear",handler:function(){var e,t,a=$VG.MainPanel.getActiveTab().el,i=[];(e=a.query(".scada-icon-selected .scada-icon-delete")).length&&(Ext.each(e,(function(e){i.push(e.getAttribute("data-id")),t=e.getAttribute("data-mode")})),$VG.onDelete({files:i,mode:t}))}},$VG.deleteAllBtn={text:$tr("visgraphics_delete_all"),iconCls:"icon-clear",handler:function(e){var t=e.mode;Ext.Msg.confirm($tr("visgraphics_delete_title"),$tr("visgraphics_delete_confirm_all"),(function(e){"yes"==e&&($VG.MainPanel.setDisabled(!0),Ext.Ajax.request({url:Scada.reqUrl("visgraphics","clear"),success:$VG.updateClearFilter,failure:$VG.update,params:Scada.encodeData({mode:t})}))}))}},$VG.clickFilterBtn=function(e,t){var a=e.getTopToolbar().findByType("button")[t];a.handler(a)},$VG.doFilter=function(e){$VG.clickFilterBtn(e,0)},$VG.clearFilter=function(e){$VG.clickFilterBtn(e,1)},$VG.addItemEvents=function(){var e=Ext.query(".scada-image-deletable");$VG.clearSelection(),Ext.each(e,(function(e){var t=Ext.get(e).removeAllListeners(),a=t.query(".scada-icon-delete")[0];t.on("mouseover",$VG.onElOver),t.on("mouseout",$VG.onElOut),t.on("click",$VG.onElClick),Ext.get(a).on("click",$VG.onDeleteClick)}))},$VG.deleteBtn.id="vis-graphics-delete-icon",$VG.deleteAllBtn.mode="icons",$VG.iconPanel=new Ext.Panel({title:$tr("visgraphics_icons"),autoScroll:!0,items:$VG.iconGrid,tbar:Scada.getImgFilterTbar("icon",$VG.addItemEvents),bbar:[{text:$tr("visgraphics_add_icon"),iconCls:"icon-add",id:"vis-graphics-add-icon-button"},"-",$VG.deleteBtn,"-",$VG.deleteAllBtn]}),$VG.deleteBtn.id="vis-graphics-delete-img",$VG.deleteAllBtn.mode="image",$VG.imgPanel=new Ext.Panel({title:$tr("visgraphics_img"),autoScroll:!0,items:$VG.imgGrid,tbar:Scada.getImgFilterTbar("img",$VG.addItemEvents),bbar:[{text:$tr("visgraphics_add_img"),iconCls:"icon-add",id:"vis-graphics-add-img-button"},"-",$VG.deleteBtn,"-",$VG.deleteAllBtn]}),$VG.fontPanel=new Ext.Panel({title:$tr("visgraphics_font"),layout:"fit",items:$VG.fontGrid,bbar:[{text:$tr("visgraphics_font_add"),iconCls:"icon-add",id:"vis-graphics-add-font-button"}]}),$VG.cssPanel=new Ext.Panel({title:$tr("visgraphics_css_edit")}),$VG.MainPanel=new Ext.TabPanel({border:!1,region:"center",margins:"5 0 0 0",items:[$VG.iconPanel,$VG.imgPanel,$VG.fontPanel,$VG.cssPanel]}),$VG.deleteGraphics=function(e,t){Ext.Ajax.request({url:Scada.reqUrl("visgraphics","delete"),success:$VG.update,failure:$VG.update,params:Scada.encodeData({files:e,mode:t})})},$VG.update=function(){Scada.Vis.iconStore.reload(),Scada.Vis.imgStore.reload(),$VG.fontStoreReload(),$VG.MainPanel.setDisabled(!1)},$VG.updateClearFilter=function(){$VG.clearFilter($VG.iconPanel),$VG.clearFilter($VG.imgPanel),$VG.update()},$VG.uploadFW=new ExtFormWindow({id:"vis-graphics-upload",window:{title:$tr("visgraphics_add"),width:460,height:210},form:{url:Scada.reqUrl("visgraphics","save"),fileUpload:!0,items:[{name:"name",fieldLabel:$tr("visgraphics_name"),maskRe:/[\w\-]/},$def.fileUpload({name:"file",fieldLabel:$tr("file"),accept:".svg,.svgz,.jpg,.jpeg,.gif,.png,.bmp,.zip"}),{name:"mode",xtype:"hidden"},$def.formInfoPanel("visgraphics_help")]},events:{onFormSubmitComplete:$VG.updateClearFilter,onFormSubmitFailed:$VG.update}}),$VG.fontUploadError=function(){Ext.Msg.alert($tr("error"),$tr("visgraphics_font_error"))},$VG.fontUploadFW=new ExtFormWindow({id:"vis-font-upload",window:{title:$tr("visgraphics_font_add"),width:460,height:160},form:{url:Scada.reqUrl("visgraphics","font-save"),fileUpload:!0,items:[$def.fileUpload({name:"file",fieldLabel:$tr("file"),accept:".ttf,.otf,.eot,.woff,.woff2,.svg"}),$def.formInfoPanel("visgraphics_font_help")]},events:{onFormSubmitComplete:$VG.fontStoreReload,onFormSubmitFailed:$VG.fontUploadError}}),$VG.onDeleteConfirm=function(e){$VG.clearSelection(),"yes"==e&&($VG.MainPanel.setDisabled(!0),Ext.Ajax.request({url:Scada.reqUrl("visgraphics","delete"),success:$VG.update,failure:$VG.update,params:Scada.encodeData(this)}))},$VG.onDelete=function(e){Ext.Msg.confirm($tr("visgraphics_delete_title"),$tr("visgraphics_delete_confirm"),$VG.onDeleteConfirm,e)},$VG.onDeleteClick=function(){$VG.clearSelection(),$VG.onDelete({files:this.getAttribute("data-id"),mode:this.getAttribute("data-mode")})},$VG.setDeleteButtonState=function(){var e=$VG.MainPanel.el.query(".scada-icon-selected").length>1?"addClass":"removeClass";Ext.getCmp("vis-graphics-delete-icon")[e]("x-btn-hl"),Ext.getCmp("vis-graphics-delete-img")[e]("x-btn-hl")},$VG.clearSelection=function(){var e;$VG.MainPanel.el&&(e=$VG.MainPanel.el.query(".scada-icon-selected"),Ext.get(e).removeClass("scada-icon-selected"),$VG.setDeleteButtonState())},$VG.onElOver=function(){var e=this.query("img")[0],t=$VG.previewEl;this.addClass("scada-icon-hover"),(e.naturalWidth>70||e.naturalHeight>70)&&(t.update('<img src="'+e.src+'">'),t.show(),t.alignTo(this,"tr?"))},$VG.onElOut=function(){this.removeClass("scada-icon-hover"),$VG.previewEl.hide()},$VG.onElClick=function(){this.toggleClass("scada-icon-selected"),$VG.setDeleteButtonState()},$VG.onFontConfirm=function(e){"yes"==e&&Ext.Ajax.request({url:Scada.reqUrl("visgraphics","font-delete"),success:$VG.fontStoreReload,failure:$VG.fontStoreReload,params:Scada.encodeData({id:this.id})})},$VG.container=new Ext.Container({id:"VisGraphics",title:$tr("visgraphics_title"),layout:"border",items:$VG.MainPanel}),$VG.init=function(){Scada.Vis.iconStore.on("load",(function(){$VG.doFilter($VG.iconPanel)})),Scada.Vis.imgStore.on("load",(function(){$VG.doFilter($VG.imgPanel)})),Ext.getCmp("vis-graphics-add-icon-button").on("click",(function(){$VG.uploadFW.show(),$VG.uploadFW.formPanel.form.findField("mode").setValue("icon")})),Ext.getCmp("vis-graphics-add-img-button").on("click",(function(){$VG.uploadFW.show(),$VG.uploadFW.formPanel.form.findField("mode").setValue("image")})),Ext.getCmp("vis-graphics-add-font-button").on("click",(function(){$VG.fontUploadFW.show()})),$VG.MainPanel.on("beforetabchange",(function(e,t){return t!=$VG.cssPanel})),$VG.MainPanel.on("afterrender",(function(){var e=$VG.MainPanel.el.query("li")[3];Ext.get(e).on("click",(function(){window.open(Scada.reqUrl("main","editor")+"?id=css")}))})),$VG.MainPanel.on("tabchange",$VG.addItemEvents),$VG.MainPanel.setActiveTab(0),$VG.previewEl=Ext.DomHelper.append(Ext.getBody(),{tag:"div",cls:"scada-preview"},!0),$VG.fontGrid.on("cellclick",(function(e,t,a){var i=e.getStore().getAt(t).get("id");"delete"==e.getColumnModel().getDataIndex(a)&&Ext.Msg.confirm($tr("visgraphics_font_title"),$tr("visgraphics_font_confirm"),$VG.onFontConfirm,{id:i})})),$VG.fontStore.on("load",(function(){var e=["Arial","Tahoma","Times New Roman","Verdana"],t=[];Ext.each($VG.fontStore.getRange(),(function(t){var a=t.data.name;e.indexOf(a)<0&&e.push(a)})),e.sort(),Ext.each(e,(function(e){t.push([e])})),Scada.Vis.fontStore.loadData(t)})),$VG.fontStore.load()},$VG.onFocus=$VG.update,Scada.Modules.push($VG);